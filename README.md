# Fake.Extensions.Release

A libary for extended release notes functions using FAKE.

- [Fake.Extensions.Release](#fakeextensionsrelease)
  - [Install/Use](#installuse)
  - [Example build.fsx module](#example-buildfsx-module)
  - [API](#api)
    - [ReleaseNotes.FAKE.AssemblyVersion.create](#releasenotesfakeassemblyversioncreate)
    - [ReleaseNotes.FAKE.Release.exists](#releasenotesfakereleaseexists)
    - [ReleaseNotes.FAKE.Release.update](#releasenotesfakereleaseupdate)
    - [ReleaseNotes.FAKE.Github.draft](#releasenotesfakegithubdraft)
    - [Release Notes in Nuget](#release-notes-in-nuget)

## Install/Use

The following shows an example dependency reference part for a build.fsx.
Note: `nuget ReleaseNotes.FAKE`

```fsharp
#r "paket:
nuget BlackFox.Fake.BuildTask
nuget ReleaseNotes.FAKE
nuget Fake.Extensions.Release
nuget Fake.Core.Target
nuget Fake.Core.Process
nuget Fake.Core.ReleaseNotes
nuget Fake.IO.FileSystem
nuget Fake.DotNet.Cli
nuget Fake.DotNet.MSBuild
nuget Fake.DotNet.AssemblyInfoFile
nuget Fake.DotNet.Paket
nuget Fake.DotNet.FSFormatting
nuget Fake.DotNet.Fsi
nuget Fake.DotNet.NuGet
nuget Fake.Api.Github
nuget Fake.DotNet.Testing.Expecto 
nuget Fake.Tools.Git //"

#if !FAKE
#load "./.fake/build.fsx/intellisense.fsx"
#r "netstandard" // Temp fix for https://github.com/dotnet/fsharp/issues/5216
#endif

open Fake.Extensions.Release
```

Should you not be able to use `open ReleaseNotes.FAKE` try the following:
- if using local tools `dotnet fake run build.fsx` else `fake run build.fsx` in the same directory as your `build.fsx`
- delete `build.fsx.lock` and `.fake` directory in the same directory as your `build.fsx` then try the step above again.

## Example build.fsx module

You can add the following to your build.fsx.

While testing i ran into some erros that you might also encounter:
- When using BlackFox.Fake.BuildTask make sure to reference `BuildTask.runOrDefaultWithArguments defaultTask` at the bottom of .fsx. When running standard Fake reference `Target.runOrDefaultWithArguments defaultTarget`. This is necessary as the several `ReleaseNotes.FAKE` targets take additional parameters. 

```fsharp
open Fake.Extensions.Release

module ReleaseNoteTasks =
    
    let createAssemblyVersion = BuildTask.create "createvfs" [] {
        AssemblyVersion.create "ReleaseNotes.FAKE"
    }

    let updateReleaseNotes = BuildTask.createFn "ReleaseNotes" [] (fun config ->
        Release.exists()

        Release.update "Freymaurer" "Fake.Extensions.Release" config
    )

    let githubDraft = BuildTask.createFn "GithubDraft" [] (fun config ->

        let body = "We are ready to go for the first release!"

        Github.draft(
            "Freymaurer",
            "ReleaseNotes.FAKE",
            (Some body),
            None,
            config
        )
    )
```

## API

### ReleaseNotes.FAKE.AssemblyVersion.create

This function creates a AssemblyVersion.fs in the same directory as `build.fsx` with the following content. It accesses the RELEASE_NOTES.md for version and date information. 

```fsharp
// Auto-Generated by FAKE; do not edit
namespace System
open System.Reflection

[<assembly: AssemblyTitleAttribute("ReleaseNotes.FAKE")>]
[<assembly: AssemblyVersionAttribute("0.1.0")>]
[<assembly: AssemblyMetadataAttribute("ReleaseDate","05/02/2021")>]
do ()

module internal AssemblyVersionInformation =
    let [<Literal>] AssemblyTitle = "ReleaseNotes.FAKE" 
    let [<Literal>] AssemblyVersion = "0.1.0"
    let [<Literal>] AssemblyMetadata_ReleaseDate = "05/02/2021"

```

### ReleaseNotes.FAKE.Release.exists 

This functions checks if RELEASE_NOTES.md exists on the same directory level and if not creates it with the following content.

```md
### 0.0.0 (Released 2021-2-5)
* Additions:
    * Initial set up for RELEASE_Notes.md
```

### ReleaseNotes.FAKE.Release.update

This is the core function of this repo. It takes optional parameters:
- semver:patch -> increases 0.0.X
- semver:minor -> increases 0.X.0
- semver:major -> increases X.0.0

in the form of `dotnet fake build -t ReleaseNotes semver:minor`. The function will check all git commits since the last one used and add them to the RELEASE_NOTES.md. If no additonal param is given (`dotnet fake build -t ReleaseNotes`) then the latest commits are added to the last version increase. If a optional param is given the version is increased and all not-yet-added commits are added to the new version.
In all cases the latest commit is added both as additional info to SemVer and as the first entry in the RELEASE_NOTES.md. 

> Due to a bug in FAKE.Core.ReleasNotes SemVer is not correctly parsed. Due to this we need to store the latest commit not only as additional info in SemVer but also as an entry.

Here are the current RELEASE_NOTES.md for this repo.
```md
### 0.1.0+75e3342 (Released 2021-2-5)
* Additions:
    * latest commit #75e3342
    * [[#75e3342](https://github.com/Freymaurer/Fake.Extensions.Release/commit/75e3342607582c42df597e1a292707fe05746ec5)] Self reference in build.fsx and create RELEASE_NOTES.md
    * [[#7979ee3](https://github.com/Freymaurer/Fake.Extensions.Release/commit/7979ee39192e239c5cabd083fe7f871e42d43c2a)] Initial commit :tada:
    * [[#d76e3ce](https://github.com/Freymaurer/Fake.Extensions.Release/commit/d76e3ce5b94a1acadd54881042cb605f072df1cb)] Repo name change and basic functionality added
* Bugfixes:
    * [[#dcdb4ad](https://github.com/Freymaurer/Fake.Extensions.Release/commit/dcdb4ad8d5624a44eeb9f5a42ed0bf628fa5e1e0)] Fix naming errors
    * [[#04d1508](https://github.com/Freymaurer/Fake.Extensions.Release/commit/04d15086c1de5bde9650b15d081294617e78bddc)] Fix reference issues

### 0.0.0 (Released 2021-2-5)
* Additions:
    * Initial set up for RELEASE_Notes.md
```

This function needs certain keywords to correctly function. If the `latest commit #xxxxxx` is removed all found commits will be added to the newest release. Should a commit hash not exist in the last x commits the function will error.

### ReleaseNotes.FAKE.Github.draft

This function will use the latest release notes from RELEASE_NOTES.md and push them to a Github release draft. To do this the function needs an additional parameter `token:GithubToken`. Such a GithubToken can be created here: https://github.com/settings/tokens.
Alternatively you can set the GithubToken as environmental variable with the name `github_token`.

Exmp: `fake build -t githubdraft token:uniquetokenitdent`

This will create a github release draft with the latest release notes and a customizable body message shown above.

![Github release draft exmp](docs/img/draft_exmp.png)

### Release Notes in Nuget

Should you use the generated RELEASE_NOTES.md to populate your nuget release notes you migth want to remove the commit urls as nuget does not parse markdown.

You cna do this with the following functions.

```fsharp
open System.Text.RegularExpressions

let commitLinkPattern = @"\[\[#[a-z0-9]*\]\(.*\)\] "

let replaceCommitLink input= Regex.Replace(input,commitLinkPattern,"")
```
